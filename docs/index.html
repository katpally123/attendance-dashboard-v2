<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Attendance Dashboard v2 — Single File</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#ffffff; --card:#f9fafb; --muted:#6b7280; --bd:#e5e7eb; }
    body { margin:0; font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:#111827; }
    header.topbar { padding:12px 16px; border-bottom:1px solid var(--bd); background:#fff; position:sticky; top:0; z-index:10;}
    header h1 { margin:0; font-size:18px; }
    main.container { max-width:1100px; margin:0 auto; padding:16px; }
    .card { background:#fff; border:1px solid var(--bd); border-radius:10px; padding:16px; margin:12px 0; box-shadow:0 1px 2px rgba(0,0,0,.03); }
    .row { display:flex; flex-wrap:wrap; gap:10px 16px; align-items:end; }
    .row label { display:flex; flex-direction:column; gap:6px; font-weight:600; }
    label.file input[type=file] { border:1px dashed var(--bd); padding:6px; border-radius:8px; }
    .checkbox { font-weight:400; display:flex; gap:8px; align-items:center; }
    .primary { padding:8px 12px; border:1px solid var(--bd); background:#111827; color:white; border-radius:8px; cursor:pointer; }
    .chips { display:flex; flex-wrap:wrap; gap:.5rem; margin:.5rem 0; }
    .chip { background:#f2f4f7; border:1px solid var(--bd); border-radius:999px; padding:.25rem .6rem; }
    .chip.ok { background:#e9f7ef; }
    .chip.warn { background:#fff4e5; }
    .hint { color:var(--muted); font-size:.9rem; }
    .grid-2 { display:grid; grid-template-columns:1fr; gap:16px; }
    @media(min-width:880px){ .grid-2{ grid-template-columns:1fr 1fr; } }
    .table { width:100%; border-collapse:collapse; }
    .table th,.table td { border:1px solid var(--bd); padding:.5rem; }
    .table th{ background:#f9fafb; text-align:left; }
    .right { text-align:right; }
    .mt { margin-top:1rem; }
    .flex-between { display:flex; align-items:center; justify-content:space-between; gap:1rem; }
    footer.foot { padding:16px; text-align:center; color:var(--muted); }
    code { background:#f3f4f6; border:1px solid var(--bd); border-radius:6px; padding:1px 4px; }
    .err { color:#b91c1c; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <header class="topbar"><h1>Attendance Dashboard v2 — Single File</h1></header>
  <main class="container">
    <section class="card">
      <h2>1) Pick day & shift</h2>
      <div class="row">
        <label>Date <input type="date" id="dateInput" /></label>
        <label>Shift
          <select id="shiftInput"><option>Day</option><option>Night</option></select>
        </label>
        <label class="checkbox">
          <input type="checkbox" id="excludeNewHires" checked />
          Exclude new hires (&lt; 3 days)
        </label>
      </div>
      <div id="shiftCodes" class="hint"></div>
    </section>

    <section class="card">
      <h2>2) Upload files (same date)</h2>
      <div class="row">
        <label class="file">Roster CSV <input type="file" id="rosterFile" accept=".csv" /></label>
        <label class="file">CAN Daily Hours Summary CSV <input type="file" id="mytimeFile" accept=".csv" /></label>
        <label class="file">Vacation CSV (optional; you can re-select the same Hours Summary)
          <input type="file" id="vacFile" accept=".csv" />
        </label>
        <button id="processBtn" class="primary">Process</button>
      </div>
      <div id="fileStatus" class="hint"></div>
      <div id="exclusion-summary" class="hint" style="margin:.5rem 0;"></div>
    </section>

    <section class="card">
      <div class="tabs">
        <button class="tab active" data-tab="dashTab">Dashboard</button>
        <button class="tab" data-tab="auditTab">Audit</button>
      </div>

      <div id="dashTab" class="tabpane active">
        <h2>Dept × AMZN/TEMP (Inbound, DA, ICQA, CRETs)</h2>
        <div id="summaryChips" class="chips"></div>
        <div class="grid-2">
          <div>
            <h3>Regular HC (Cohort Expected)</h3>
            <p class="hint" id="expectedNote"></p>
            <table id="expectedTable" class="table"></table>
          </div>
          <div>
            <h3>Regular HC Present (Excluding Swaps)</h3>
            <table id="presentTable" class="table"></table>
          </div>
        </div>
      </div>

      <div id="auditTab" class="tabpane">
        <div class="flex-between">
          <h2 style="margin:0">Audit & Verify</h2>
          <button id="downloadAudit" class="primary">Download Audit CSV</button>
        </div>
        <div id="verify" class="mt"></div>
      </div>
    </section>
  </main>
  <footer class="foot">
    <small>Single-file build — DA included; auto-excludes Vacation (col S) & Banked Holiday (col Q=12h).</small>
  </footer>

  <script>
  // Tabs
  document.addEventListener("click", (e) => {
    const b = e.target.closest(".tab"); if (!b) return;
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    document.querySelectorAll(".tabpane").forEach(x=>x.classList.remove("active"));
    b.classList.add("active"); document.getElementById(b.dataset.tab).classList.add("active");
  });

  // Elements
  const dateEl = document.getElementById("dateInput");
  const shiftEl = document.getElementById("shiftInput");
  const newHireEl = document.getElementById("excludeNewHires");
  const rosterEl = document.getElementById("rosterFile");
  const mytimeEl = document.getElementById("mytimeFile");
  const vacEl = document.getElementById("vacFile");
  const processBtn = document.getElementById("processBtn");
  const fileStatus = document.getElementById("fileStatus");
  const shiftCodesEl = document.getElementById("shiftCodes");
  const summaryChips  = document.getElementById("summaryChips");
  const expectedNote  = document.getElementById("expectedNote");
  const expectedTable = document.getElementById("expectedTable");
  const presentTable  = document.getElementById("presentTable");

  // Minimal inline settings so the file is standalone
  const SETTINGS = {
    present_markers: ["X","YES","Y"],
    shift_schedule: {
      Day:   { Monday:["D1","D2","D3","D4"], Tuesday:["D1","D2","D3","D4"], Wednesday:["D1","D2","D3","D4"], Thursday:["D1","D2","D3","D4"], Friday:["D1","D2","D3","D4"], Saturday:["D1","D2"], Sunday:["D1","D2"] },
      Night: { Monday:["N1","N2"], Tuesday:["N1","N2"], Wednesday:["N1","N2"], Thursday:["N1","N2"], Friday:["N1","N2"], Saturday:["N1"], Sunday:["N1"] }
    },
    departments: {
      Inbound: { dept_ids:["1211010","1211020","1299010","1299020"] },
      DA:      { dept_ids:["1211030","1211040","1299030","1299040"] },
      ICQA:    { dept_ids:["1299070","1211070"], management_area_id:"27" },
      CRETs:   { dept_ids:["1299070","1211070"], management_area_id:"22" }
    }
  };
  const ORDER = ["Inbound","DA","ICQA","CRETs"];

  // Init
  (function init(){
    const today = new Date(); dateEl.value = today.toISOString().slice(0,10);
    shiftEl.value = "Day"; renderShiftCodes();
    dateEl.addEventListener("change", renderShiftCodes);
    shiftEl.addEventListener("change", renderShiftCodes);
  })();

  function toDayName(iso){ return new Date(iso+"T00:00:00").toLocaleDateString("en-US",{weekday:"long"}); }
  function renderShiftCodes(){
    const dayName = toDayName(dateEl.value || new Date().toISOString().slice(0,10));
    const shift = shiftEl.value; const codes = (SETTINGS.shift_schedule?.[shift]?.[dayName]) || [];
    shiftCodesEl.innerHTML = `Shifts for <b>${dayName}</b> — <b>${shift}</b>: ${codes.map(c=>`<code>${c}</code>`).join(" ")}`;
  }

  // CSV
  function parseCSVFile(file, opts={header:true, skipFirstLine:false}){
    return new Promise((resolve,reject)=>{
      if (!file) return resolve([]);
      const reader = new FileReader();
      reader.onerror = ()=>reject(new Error("Failed to read file"));
      reader.onload = () => {
        let text = reader.result;
        if (opts.skipFirstLine){ const i = text.indexOf("\\n"); text = i>=0 ? text.slice(i+1) : text; }
        Papa.parse(text, { header: opts.header, skipEmptyLines: true, transformHeader: h => h.trim(),
          complete: res => resolve(res.data)
        });
      };
      reader.readAsText(file);
    });
  }

  // Utils
  const _txt = v => (v ?? "").toString().trim();
  function canon(s){ return String(s||"").trim().toLowerCase().replace(/\s+/g," ").replace(/[^\w? ]/g,""); }
  function findKey(row, candidates){
    const keys = Object.keys(row||{}), wanted = candidates.map(canon);
    for (const k of keys){ const ck = canon(k); if (wanted.includes(ck)) return k; }
    for (const k of keys){ const ck = canon(k).replace(/\\?/g,""); if (wanted.includes(ck)) return k; }
    return null;
  }
  function classifyEmpType(v){
    const x = canon(v); if (!x) return "UNKNOWN";
    if (/(amzn|amazon|blue badge|bb|fte|full time|part time|pt)\\b/.test(x)) return "AMZN";
    if (/(temp|temporary|seasonal|agency|vendor|contract|white badge|wb|csg|adecco|randstad)/.test(x)) return "TEMP";
    if (x==="temp") return "TEMP"; if (x==="amzn") return "AMZN"; return "UNKNOWN";
  }
  function normalizeId(v){ const t=String(v??"").trim(); const d=t.replace(/\\D/g,""); const n=d.replace(/^0+/,""); return n||t; }
  function parseDateLoose(s){ const d = new Date(s); return isNaN(d) ? null : d; }
  const eidOf = row => _txt(row?.EID || row?.["Person Number"] || row?.PersonNumber || row?.["Associate ID"] || row?.ID);

  // Exclusions (Q=Banked 12h, S>0 Vacation); accept 12, 12.0, 12:00, 12:00:00
  const COL_Q_IDX = 16, COL_S_IDX = 18;
  function readCol(row, idx, ...names){ if (row && !Array.isArray(row)) { for (const n of names) if (row[n]!=null) return row[n]; } if (Array.isArray(row)) return row[idx]; return ""; }
  function toMinutes(hh){ const t=_txt(hh); if (/^\\d+(\\.\\d+)?$/.test(t)) return Math.round(parseFloat(t)*60);
    const m=t.match(/^(\\d{1,2})(?::(\\d{2}))?(?::\\d{2})?$/); if(!m) return 0; return parseInt(m[1],10)*60 + parseInt(m[2]||"0",10); }
  function buildExclusions(rows){ const vacSet=new Set(), bankedSet=new Set();
    for(const r of rows||[]){ const eid=eidOf(r); if(!eid) continue;
      const bankedStr=readCol(r, COL_Q_IDX,"Banked Holiday","Banked Holiday Hours","Banked","Q");
      const vacStr=readCol(r, COL_S_IDX,"Vacation","Vacation Hours","S");
      if (toMinutes(bankedStr)===720) bankedSet.add(eid);
      if (toMinutes(vacStr)>0)        vacSet.add(eid);
    }
    return { vacSet, bankedSet, excludeSet:new Set([...vacSet,...bankedSet]) };
  }
  function renderExclusionSummary(sets){
    const el=document.getElementById("exclusion-summary"); if(!el||!sets) return;
    el.textContent=`Auto-excluded → Vacation: ${sets.vacSet.size} | Banked: ${sets.bankedSet.size} | Total (unique): ${sets.excludeSet.size}`;
  }

  function sumBlock(block){ const acc={AMZN:0,TEMP:0,TOTAL:0}; for(const k of Object.keys(block)){ acc.AMZN+=block[k].AMZN; acc.TEMP+=block[k].TEMP; acc.TOTAL+=block[k].TOTAL; } return acc; }
  function renderTables(expected, present){
    const header=`<thead><tr><th>Department</th><th class="right">AMZN</th><th class="right">TEMP</th><th class="right">TOTAL</th></tr></thead>`;
    const row=v=>`<tr><td>${v[0]}</td><td class="right">${v[1].AMZN}</td><td class="right">${v[1].TEMP}</td><td class="right">${v[1].TOTAL}</td></tr>`;
    expectedTable.innerHTML = header + `<tbody>${Object.entries(expected).map(row).join("")}</tbody>
      <tfoot><tr><td>Total</td><td class="right">${sumBlock(expected).AMZN}</td><td class="right">${sumBlock(expected).TEMP}</td><td class="right">${sumBlock(expected).TOTAL}</td></tr></tfoot>`;
    presentTable.innerHTML = header + `<tbody>${Object.entries(present).map(row).join("")}</tbody>
      <tfoot><tr><td>Total</td><td class="right">${sumBlock(present).AMZN}</td><td class="right">${sumBlock(present).TEMP}</td><td class="right">${sumBlock(present).TOTAL}</td></tr></tfoot>`;
  }
  function renderChips(expected, present, dayName, shift, codes){
    const exp=sumBlock(expected).TOTAL, pre=sumBlock(present).TOTAL, pct=exp?((pre/exp)*100).toFixed(1):"0.0";
    document.getElementById("summaryChips").innerHTML=
      `<span class="chip">Day: <b>${dayName}</b></span>
       <span class="chip">Shift: <b>${shift}</b></span>
       <span class="chip">Corners: ${codes.map(c=>`<code>${c}</code>`).join(" ")}</span>
       <span class="chip">Expected Total: <b>${exp}</b></span>
       <span class="chip ${pre>=exp?'ok':'warn'}">Present Total: <b>${pre}</b> (${pct}%)</span>`;
  }

  processBtn.addEventListener("click", async ()=>{
    fileStatus.classList.remove("err");
    if (!dateEl.value){ fileStatus.innerHTML='<span class="err">Pick a date.</span>'; return; }
    if (!rosterEl.files[0] || !mytimeEl.files[0]){ fileStatus.innerHTML='<span class="err">Upload both Roster and Hours Summary CSVs.</span>'; return; }
    const dayName = toDayName(dateEl.value); const shift = shiftEl.value;
    const codes = SETTINGS.shift_schedule?.[shift]?.[dayName] || [];
    if (!codes.length){ fileStatus.innerHTML='<span class="err">No shift codes configured for that selection.</span>'; return; }

    fileStatus.textContent = "Parsing files…";
    try {
      const [rosterRaw, hoursSummaryRows, vacRowsMaybe] = await Promise.all([
        parseCSVFile(rosterEl.files[0], {header:true}),
        parseCSVFile(mytimeEl.files[0], {header:true, skipFirstLine:true}),
        parseCSVFile(vacEl.files[0], {header:true}) // optional; can be same file
      ]);

      // Build exclusions from Hours Summary + optional Vacation file (union)
      let EX = buildExclusions(hoursSummaryRows);
      if (vacRowsMaybe && vacRowsMaybe.length) {
        const EX2 = buildExclusions(vacRowsMaybe);
        EX = { vacSet:new Set([...EX.vacSet,...EX2.vacSet]),
               bankedSet:new Set([...EX.bankedSet,...EX2.bankedSet]),
               excludeSet:new Set([...EX.excludeSet,...EX2.excludeSet]) };
      }
      renderExclusionSummary(EX);
      expectedNote.textContent = `Expected = Corner-filtered cohort − Time-off (Vacation col S + Banked col Q). `+
                                 `Vacation: ${EX.vacSet.size} | Banked: ${EX.bankedSet.size} | Total unique: ${EX.excludeSet.size}`;

      // Resolve roster headers
      const r0 = rosterRaw[0] || {};
      const R_EMP   = findKey(r0, ["Employee ID","Person Number","Person ID","Badge ID"]);
      const R_DEPT  = findKey(r0, ["Department ID","Home Department ID","Dept ID"]);
      const R_AREA  = findKey(r0, ["Management Area ID","Mgmt Area ID","Area ID","Area"]);
      const R_TYPE  = findKey(r0, ["Employment Type","Associate Type","Worker Type","Badge Type","Company"]);
      const R_SP    = findKey(r0, ["Shift Pattern","Schedule Pattern","Shift"]);
      const R_CORNER= findKey(r0, ["Corner","Corner Code"]);
      const R_START = findKey(r0, ["Employment Start Date","Hire Date","Start Date"]);
      if (!R_EMP || !R_DEPT || !(R_SP || R_CORNER)) throw new Error("Missing roster cols (Employee ID, Department ID, Shift Pattern/Corner)");

      // Hours Summary → On Prem
      const m0 = hoursSummaryRows[0] || {};
      const M_PERSON = findKey(m0, ["Person ID","Employee ID","Person Number","ID"]);
      const M_ONPREM = findKey(m0, ["On Premises","On Premises?","OnPremises","On Premise"]);
      if (!M_PERSON || !M_ONPREM) throw new Error("Missing Hours Summary cols (Person ID / On Premises)");
      const onPremMap = new Map();
      for (const row of hoursSummaryRows){
        const pid = normalizeId(row[M_PERSON]);
        const val = String(row[M_ONPREM] ?? "").trim().toUpperCase();
        if (!pid) continue;
        const isOnPrem = (SETTINGS.present_markers || ["X"]).includes(val);
        onPremMap.set(pid, (onPremMap.get(pid) || false) || isOnPrem);
      }

      // Enrich roster
      const rosterEnriched = rosterRaw.map(r => {
        const empId  = normalizeId(r[R_EMP]);
        const deptId = String(r[R_DEPT] ?? "").trim();
        const areaId = String((R_AREA? r[R_AREA] : "") ?? "").trim();
        const empType= classifyEmpType(r[R_TYPE]);
        const sp     = String((R_SP? r[R_SP] : "") ?? "");
        const corner = R_CORNER ? String(r[R_CORNER] ?? "").trim() : (sp||"").slice(0,2);
        const met    = (sp?.length>=3) ? sp[0]+sp[2] : "";
        const start  = R_START ? parseDateLoose(r[R_START]) : null;
        const onPrem = onPremMap.get(empId) === true;
        const excluded = EX.excludeSet.has(empId);
        return { empId, deptId, areaId, empType, sp, corner, met, start, onPrem, excluded };
      });

      // Corner filter
      let filtered = rosterEnriched.filter(x => codes.includes(x.corner));

      // New hires exclusion (3-day rule)
      if (newHireEl && newHireEl.checked){
        const dayStart = new Date(dateEl.value+"T00:00:00");
        filtered = filtered.filter(x => {
          if (!x.start) return true;
          const diffDays = Math.floor((dayStart - x.start)/(1000*60*60*24));
          return diffDays >= 3;
        });
      }

      // Remove time-off
      const rosterNoTimeOff = filtered.filter(x => !x.excluded);

      // Buckets
      const cfg = SETTINGS.departments;
      const DA_IDS = cfg.DA.dept_ids;
      const inboundMinusDA = x => cfg.Inbound.dept_ids.includes(x.deptId) && !DA_IDS.includes(x.deptId);
      const belongsDA      = x => DA_IDS.includes(x.deptId);
      const belongsICQA    = x => cfg.ICQA.dept_ids.includes(x.deptId) && x.areaId === cfg.ICQA.management_area_id;
      const belongsCRETs   = x => cfg.CRETs.dept_ids.includes(x.deptId) && x.areaId === cfg.CRETs.management_area_id;

      const group = (rows, pred) => rows.filter(pred);
      const expGroups = {
        Inbound: group(rosterNoTimeOff, inboundMinusDA),
        DA:      group(rosterNoTimeOff, belongsDA),
        ICQA:    group(rosterNoTimeOff, belongsICQA),
        CRETs:   group(rosterNoTimeOff, belongsCRETs)
      };
      const preGroups = {
        Inbound: group(rosterNoTimeOff, x => inboundMinusDA(x) && x.onPrem),
        DA:      group(rosterNoTimeOff, x => belongsDA(x)      && x.onPrem),
        ICQA:    group(rosterNoTimeOff, x => belongsICQA(x)    && x.onPrem),
        CRETs:   group(rosterNoTimeOff, x => belongsCRETs(x)   && x.onPrem)
      };
      const countByType = rows => {
        const amzn = rows.filter(x => x.empType==="AMZN").length;
        const temp = rows.filter(x => x.empType==="TEMP").length;
        return { AMZN: amzn, TEMP: temp, TOTAL: amzn+temp };
      };
      const expected = {
        Inbound: countByType(expGroups.Inbound),
        DA:      countByType(expGroups.DA),
        ICQA:    countByType(expGroups.ICQA),
        CRETs:   countByType(expGroups.CRETs),
      };
      const present = {
        Inbound: countByType(preGroups.Inbound),
        DA:      countByType(preGroups.DA),
        ICQA:    countByType(preGroups.ICQA),
        CRETs:   countByType(preGroups.CRETs),
      };

      const ordered = obj => Object.fromEntries(ORDER.map(k=>[k, obj[k]]));
      renderTables(ordered(expected), ordered(present));
      renderChips(expected, present, dayName, shift, codes);
      fileStatus.textContent = "Done.";

      // Audit/Verify
      const tagDept = (x)=>{
        if (belongsDA(x)) return "DA";
        if (inboundMinusDA(x)) return "Inbound";
        if (belongsICQA(x)) return "ICQA";
        if (belongsCRETs(x)) return "CRETs";
        return "Other";
      };
      const auditRows = filtered.map(x=>({
        empId: x.empId, empType: x.empType, deptId: x.deptId, areaId: x.areaId,
        corner: x.corner, onPrem: x.onPrem ? "YES" : "NO", excluded: x.excluded ? "YES" : "NO",
        bucket: tagDept(x),
      }));
      const sampleOf = (rows, pred)=> rows.filter(pred).slice(0,200);
      const samples = {
        Inbound: {
          "exp-amzn": sampleOf(expGroups.Inbound, r=>r.empType==="AMZN"),
          "exp-temp": sampleOf(expGroups.Inbound, r=>r.empType==="TEMP"),
          "exp-tot":  expGroups.Inbound.slice(0,200),
          "pre-amzn": sampleOf(preGroups.Inbound, r=>r.empType==="AMZN"),
          "pre-temp": sampleOf(preGroups.Inbound, r=>r.empType==="TEMP"),
          "pre-tot":  preGroups.Inbound.slice(0,200)
        },
        DA: {
          "exp-amzn": sampleOf(expGroups.DA, r=>r.empType==="AMZN"),
          "exp-temp": sampleOf(expGroups.DA, r=>r.empType==="TEMP"),
          "exp-tot":  expGroups.DA.slice(0,200),
          "pre-amzn": sampleOf(preGroups.DA, r=>r.empType==="AMZN"),
          "pre-temp": sampleOf(preGroups.DA, r=>r.empType==="TEMP"),
          "pre-tot":  preGroups.DA.slice(0,200)
        },
        ICQA: {
          "exp-amzn": sampleOf(expGroups.ICQA, r=>r.empType==="AMZN"),
          "exp-temp": sampleOf(expGroups.ICQA, r=>r.empType==="TEMP"),
          "exp-tot":  expGroups.ICQA.slice(0,200),
          "pre-amzn": sampleOf(preGroups.ICQA, r=>r.empType==="AMZN"),
          "pre-temp": sampleOf(preGroups.ICQA, r=>r.empType==="TEMP"),
          "pre-tot":  preGroups.ICQA.slice(0,200)
        },
        CRETs: {
          "exp-amzn": sampleOf(expGroups.CRETs, r=>r.empType==="AMZN"),
          "exp-temp": sampleOf(expGroups.CRETs, r=>r.empType==="TEMP"),
          "exp-tot":  expGroups.CRETs.slice(0,200),
          "pre-amzn": sampleOf(preGroups.CRETs, r=>r.empType==="AMZN"),
          "pre-temp": sampleOf(preGroups.CRETs, r=>r.empType==="TEMP"),
          "pre-tot":  preGroups.CRETs.slice(0,200)
        }
      };

      renderVerify({
        day: dayName, shift,
        presentMarkers: SETTINGS.present_markers || ["X"],
        rosterRows: rosterRaw.length,
        mytimeRows: hoursSummaryRows.length,
        vacExcluded: EX.vacSet.size, bankedExcluded: EX.bankedSet.size, totalExcluded: EX.excludeSet.size,
        rosterEnriched: filtered.length, afterCorner: filtered.length,
        idMatches: (filtered.filter(x => x.empId && (x.onPrem===true || x.onPrem===false))).length,
        byDept: {
          Inbound: {expected: expected.Inbound, present: present.Inbound},
          DA:      {expected: expected.DA,      present: present.DA},
          ICQA:    {expected: expected.ICQA,    present: present.ICQA},
          CRETs:   {expected: expected.CRETs,   present: present.CRETs}
        },
        samples, auditRows
      });

    } catch (err){
      console.error(err);
      fileStatus.innerHTML = `<span class="err">Error: ${err.message || "processing failed"}</span>`;
      alert(err.message || "Error processing files.");
    }
  });

  function renderVerify(stats) {
    const el = document.getElementById("verify"); if (!el) return;
    const pill = (k,v) => `<span class="chip"><b>${k}</b>: ${v}</span>`;
    const row = (name, obj, key) => `
      <tr>
        <td>${name}</td>
        <td class="right"><a href="#" data-key="${key}" data-type="exp-amzn">${obj.expected.AMZN}</a></td>
        <td class="right"><a href="#" data-key="${key}" data-type="exp-temp">${obj.expected.TEMP}</a></td>
        <td class="right"><a href="#" data-key="${key}" data-type="exp-tot">${obj.expected.TOTAL}</a></td>
        <td class="right"><a href="#" data-key="${key}" data-type="pre-amzn">${obj.present.AMZN}</a></td>
        <td class="right"><a href="#" data-key="${key}" data-type="pre-temp">${obj.present.TEMP}</a></td>
        <td class="right"><a href="#" data-key="${key}" data-type="pre-tot">${obj.present.TOTAL}</a></td>
      </tr>`;
    el.innerHTML = `
      <div class="chips">
        ${pill("Roster rows", stats.rosterRows)}
        ${pill("Hours Summary rows", stats.mytimeRows)}
        ${pill("Vacation excluded", stats.vacExcluded)}
        ${pill("Banked excluded", stats.bankedExcluded)}
        ${pill("Total excluded (unique)", stats.totalExcluded)}
        ${pill("ID matches", `${stats.idMatches} / ${stats.rosterEnriched}`)}
        ${pill("Corner filter", `${stats.afterCorner} rows`)}
        ${pill("Present markers", stats.presentMarkers.join(" / "))}
      </div>
      <h4>Drill-down (click any number)</h4>
      <table class="table">
        <thead>
          <tr>
            <th>Dept</th>
            <th class="right">Exp AMZN</th><th class="right">Exp TEMP</th><th class="right">Exp TOTAL</th>
            <th class="right">Pre AMZN</th><th class="right">Pre TEMP</th><th class="right">Pre TOTAL</th>
          </tr>
        </thead>
        <tbody>
          ${row("Inbound", stats.byDept.Inbound, "Inbound")}
          ${row("DA",      stats.byDept.DA,      "DA")}
          ${row("ICQA",    stats.byDept.ICQA,    "ICQA")}
          ${row("CRETs",   stats.byDept.CRETs,   "CRETs")}
        </tbody>
      </table>
      <div id="drill" class="mt"></div>
    `;
    el.querySelectorAll("a[data-key]").forEach(a=>{
      a.addEventListener("click", ev=>{
        ev.preventDefault();
        const key = a.dataset.key, type = a.dataset.type;
        const sample = stats.samples[key][type] || [];
        const drill = document.getElementById("drill");
        drill.innerHTML = `
          <div class="card">
            <b>${key} → ${type}</b>
            <pre style="white-space:pre-wrap; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;">
${sample.slice(0,80).map(x=>`${x.empId} | ${x.empType} | dept=${x.deptId} area=${x.areaId} | corner=${x.corner} | onPrem=${x.onPrem} | excluded=${x.excluded ? "YES" : "NO"}`).join("\n") || "(no rows)"}
            </pre>
          </div>`;
      });
    });

    const dl = document.getElementById("downloadAudit");
    if (dl) dl.onclick = ()=>{
      const rows = stats.auditRows; if (!rows?.length) return alert("No audit rows to download.");
      const headers = Object.keys(rows[0]);
      const escape = v => `"${String(v??"").replace(/"/g,'""')}"`;
      const csv = [headers.join(","), ...rows.map(r=>headers.map(h=>escape(r[h])).join(","))].join("\n");
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"}), url = URL.createObjectURL(blob);
      const a = document.createElement("a"); a.href = url; a.download = `audit_${stats.day}_${stats.shift}.csv`; a.click(); URL.revokeObjectURL(url);
    };
  }
  </script>
</body>
</html>
